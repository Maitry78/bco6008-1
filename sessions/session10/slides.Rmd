---
title: "6008: Unsupervised learning - clustering 2"
subtitle: "âš”<br/>Session 10"
author: "Dr Maria Prokofieva"
date: "17/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE,   
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 4,
                      fig.width = 8,
                      fig.align = "center")
```
background-image: url("img/bg.jpg")

---
----

Well, it's been an *interesting* election season so far, right? Everybody holding up OK? Utah held its caucuses this past Tuesday on March 22 and I thought I would do a bit of plotting to show the results. We can get the JSON data from CNN, as pointed out by Bob Rudis in [his post here](http://rud.is/b/2016/03/07/primary-plotting/). Utah's results were not available when he wrote that post but I was able to poke around and find them using the guidance he provided there. Many thanks to CNN for all the hard work they do in reporting!



```{r}
library(jsonlite)
utahRJSON <- fromJSON("http://data.cnn.com/ELECTION/2016primary/UT/county/S.json",
               flatten=TRUE)
utahDJSON <- fromJSON("http://data.cnn.com/ELECTION/2016primary/UT/county/E.json",
               flatten=TRUE)
```

Every county in Utah was won by the same Republican or Democratic candidate, so it will not be particularly interesting to make maps showing who won the caucuses. Instead, what I'm going for here is to see if there are any differences in voting patterns for the various candidates. To do that, let's make a data frame for each candidate with his/her results. First up, the Republicans.


```{r}
library(purrr)
library(dplyr)
cruz <- mutate(map_df(utahRJSON$counties$race.candidates, function(x) {
        x %>% filter(lname == "Cruz")
        }), FIPS=utahRJSON$counties$countycode)
kasich <- mutate(map_df(utahRJSON$counties$race.candidates, function(x) {
        x %>% filter(lname == "Kasich")
        }), FIPS=utahRJSON$counties$countycode)
trump <- mutate(map_df(utahRJSON$counties$race.candidates, function(x) {
        x %>% filter(lname == "Trump")
        }), FIPS=utahRJSON$counties$countycode)
```

This was my first time to use `purrr`, Hadley Wickham's library which is sort of similar to `dplyr` but for functions. I am a HUGE fan of `dplyr` and it is very soothing and makes me happy, so I am looking forward to getting used to `purrr` and using it more. Let's do the Democratic candidates now.


```{r}
sanders <- mutate(map_df(utahDJSON$counties$race.candidates, function(x) {
        x %>% filter(lname == "Sanders")
        }), FIPS=utahDJSON$counties$countycode)
clinton <- mutate(map_df(utahDJSON$counties$race.candidates, function(x) {
        x %>% filter(lname == "Clinton")
        }), FIPS=utahDJSON$counties$countycode)
```

For plotting, I am going to use Ari Lamstein's `choroplethr` package which needs the data in wide format. Let's start getting that set up, first with the Republicans.


```{r}
cruzwide <- cruz %>% select(region = FIPS, cruzpct = vpct, cruzvotes = votes)
kasichwide <- kasich %>% select(region = FIPS, kasichpct = vpct, kasichvotes = votes)
trumpwide <- trump %>% select(region = FIPS, trumppct = vpct, trumpvotes = votes)
republicans <- left_join(cruzwide, kasichwide)
republicans <- left_join(republicans, trumpwide)
```

Now for the Democrats.


```{r}
clintonwide <- clinton %>% select(region = FIPS, clintonpct = vpct, clintonvotes = votes)
sanderswide <- sanders %>% select(region = FIPS, sanderspct = vpct, sandersvotes = votes)
democrats <- left_join(sanderswide, clintonwide)
```

What do these data frames look like?


```{r}
head(republicans)
```



```
## Source: local data frame [6 x 7]
## 
##   region cruzpct cruzvotes kasichpct kasichvotes trumppct trumpvotes
##    (int)   (int)     (int)     (int)       (int)    (int)      (int)
## 1  49001      63       229        13          47       24         87
## 2  49003      74      3314        14         638       12        520
## 3  49005      71      7172        19        1892       10       1049
## 4  49007      61       595         9          90       30        293
## 5  49009      38        36        27          25       35         33
## 6  49011      68     17528        20        5214       11       2902
```



```{r}
head(democrats)
```



```
## Source: local data frame [6 x 5]
## 
##   region sanderspct sandersvotes clintonpct clintonvotes
##    (int)      (int)        (int)      (int)        (int)
## 1  49001          0            0          0            0
## 2  49003         76          281         24           90
## 3  49005         81         2906         18          630
## 4  49007         62          235         33          128
## 5  49009         87           13          6            1
## 6  49011         82         3563         17          747
```

## Now, Some Plots!

Before we look at any plots, I'd like to tell/remind everyone that the population in Utah is not evenly distributed. I've done some demographic mapping for Utah in a [previous blog post](http://juliasilge.com/blog/This-Is-the-Place/), but just as a reminder, Salt Lake County (where I live) has a population over 1 million and the rest of the counties have much lower populations. Utah County, just to the south of Salt Lake, has a population that is about half of Salt Lake's and the numbers drop off precipitously after that. There are a number of very rural counties with populations in the 1000s. Utah's Republican caucus has a rule where if someone gets more than 50% of the vote, then a winner-takes-all rule kicks in for delegates. Utah's Democratic caucus does not have a similar rule; it chooses some delegates based on the overall statewide vote and some based on votes in the four congressional districts.

SO! Let's do this.


```{r}
library(choroplethr)
library(choroplethrMaps)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
republicans$value <- republicans$cruzpct
choro1 = CountyChoropleth$new(republicans)
choro1$set_zoom("utah")
choro1$title = "Ted Cruz"
choro1$set_num_colors(1)
choro1$ggplot_polygon = geom_polygon(aes(fill = value), color = NA)
choro1$ggplot_scale = scale_fill_gradientn(name = "Percent", 
                                          colours = brewer.pal(8, "YlGn"))
republicans$value <- republicans$kasichpct
choro2 = CountyChoropleth$new(republicans)
choro2$set_zoom("utah")
choro2$title = "John Kasich"
choro2$set_num_colors(1)
choro2$ggplot_polygon = geom_polygon(aes(fill = value), color = NA)
choro2$ggplot_scale = scale_fill_gradientn(name = "Percent", 
                                          colours = brewer.pal(8, "Purples"))
republicans$value <- republicans$trumppct
choro3 = CountyChoropleth$new(republicans)
choro3$set_zoom("utah")
choro3$title = "Donald Trump"
choro3$set_num_colors(1)
choro3$ggplot_polygon = geom_polygon(aes(fill = value), color = NA)
choro3$ggplot_scale = scale_fill_gradientn(name = "Percent", 
                                          colours = brewer.pal(8, "YlOrRd"))
grid.arrange(choro1$render() + theme(text=element_text(family="KerkisSans")), 
             choro2$render() + theme(text=element_text(family="KerkisSans")), 
             choro3$render() + theme(text=element_text(family="KerkisSans")), ncol = 3)
```

![center](/figs/2016-03-25-Mapping-Utah-Caucus/unnamed-chunk-8-1.png)

